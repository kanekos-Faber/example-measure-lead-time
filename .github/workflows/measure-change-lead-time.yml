name: 初回コミットからマージまでの時間を計測してコメント
on:
  pull_request:
    branches:
    - develop
    types: [closed]

jobs:
  lead-time:
    if: github.event.pull_request.merged == true
    permissions: write-all
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: echo
        run: echo 'Hello world'
      - name: post github info
        run: |
          gh api graphql -f id="${{ github.event.pull_request.node_id }}" -f query='
            query ($id: ID!) {
              node(id: $id) {
                ... on PullRequest {
                  repository {
                    name
                  }
                  title
                  author {
                    login
                  }
                  url
                  baseRefName
                  headRefName
                  commits(first: 1) {
                    nodes {
                      commit {
                        authoredDate
                      }
                    }
                  }
                  createdAt
                  mergedAt
                  additions
                  deletions
                  reviews(first: 1) {
                    nodes {
                      ... on PullRequestReview {
                        createdAt
                      }
                    }
                  }
                }
              }
            }
          ' |
          # tokenで認証を行なっている
          jq -r --arg token ${{ secrets.GAS_POST_API_METRIX_TOKEN }} '.data.node |
            {
              data: {
                repository: .repository.name,
                title: .title,
                user: .author.login,
                url: .url,
                base: .baseRefName,
                head: .headRefName,
                firstCommittedAt: .commits.nodes[0].commit.authoredDate,
                createdAt: .createdAt,
                firstReviewedAt: .reviews.nodes[0].createdAt,
                mergedAt: .mergedAt,
                additions: .additions,
                deletions: .deletions
              },
              type: "lead_time",
              token: $token
            } |
            @json' |
          curl -L -H "Content-Type: application/json" -d @- "https://script.googleapis.com/v1/scripts/AKfycbzmBYlRJFoxNT9ti2j__TdaHcvFdwPKpIxfAKx4GHwljW4JFRwCcg1GGWPqpGGfbHxj:exec"
